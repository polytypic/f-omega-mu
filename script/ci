#!/bin/bash

# shellcheck source=common
. "${BASH_SOURCE%/*}/common"

export TIMEFORMAT="CPU: %Us, Real: %Es"

folded() {
  echo
  echo "JOB: $1"
  shift
  time "$@"
}

folded "Building docs" \
  script/docs

run_error_examples() {
  for fom in examples/errors/*.fom; do
    out="${fom%.fom}.out"
    if $FOM_COMMAND "$fom" > "$out"; then
      echo "$fom unexpectedly ran successfully"
      exit 1
    fi
  done
}

build_and_test() {
  OPTS=(--root=.)

  if [ -n "$PROFILE" ]; then
     OPTS+=(--profile "$PROFILE")
  fi

  folded "Building" \
    opam exec -- dune build "${OPTS[@]}"

  folded "Testing" \
    opam exec -- dune test "${OPTS[@]}"

  folded "Running examples" \
    $FOM_COMMAND examples/*.fom

  folded "Running error examples" \
    run_error_examples
}

if [ "$CI" = true ]; then
  PROFILE='' build_and_test
  folded "Cleaning" \
    opam exec -- dune clean
fi

PROFILE=release build_and_test

folded "Compiling examples" \
  script/compile-examples
